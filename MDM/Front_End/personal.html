<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Teacher Profile | MATHION</title>
    <link rel="stylesheet" href="./css/lib/bootstrap.min.css">
    <link rel="stylesheet" href="./layer/theme/default/layer.css">
    <link rel="stylesheet" type="text/css" href="./css/reponse.css">
    <link rel="stylesheet" type="text/css" href="./css/custom.css">
    <link rel="stylesheet" type="text/css" href="./css/common.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .info-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 25px;
            margin: 20px auto;
            max-width: 800px;
        }

        .info-section {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }

        .info-section:last-child {
            border-bottom: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-view {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-view:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .form-view.error {
            border-color: #dc3545;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .btn-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-standard {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background-color: #4a89dc;
            color: white;
            border: none;
        }

        .btn-save {
            background-color: #37bc9b;
            color: white;
            border: none;
        }

        .btn-cancel {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-standard:hover {
            opacity: 0.9;
        }

        .required::after {
            content: "*";
            color: #dc3545;
            margin-left: 4px;
        }
        /* 全局基础样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            position: relative;
            min-height: 100vh;
            background-color: #f5f7fa;
            color: #333;
        }
        /* 页头 */
        #header {
            background-color: #fff;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        #header h1 {
            margin: 0;
            font-size: 22px;
            text-align: center;
            color: #3a3a3a;
            font-weight: 500;
        }
        /* 用户信息区域：绝对定位到页头右侧 */
        #user-menu {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 20px;
            transition: all 0.3s;
        }
        #user-menu:hover {
            background-color: #f0f5ff;
        }
        #user-menu::before {
            content: '\f007';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-right: 8px;
            color: #4a89dc;
        }
        #user-menu span {
            font-weight: 500;
            color: #4a5568;
        }
        /* 下拉菜单 */
        #dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: #fff;
            border-radius: 8px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 150px;
            z-index: 100;
            overflow: hidden;
            margin-top: 8px;
        }
        #dropdown a {
            display: flex;
            padding: 12px 16px;
            text-decoration: none;
            color: #4a5568;
            transition: all 0.2s;
            align-items: center;
        }
        #dropdown a:hover {
            background-color: #f0f5ff;
            color: #4a89dc;
        }
        #dropdown a::before {
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-right: 8px;
        }
        #personalInfo::before {
            content: '\f007';
        }
        #logout::before {
            content: '\f2f5';
        }
        /* 返回按钮：绝对定位到页头左侧 */
        .btn-back {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #f0f5ff;
            color: #4a89dc;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-back:hover {
            background-color: #e0ecff;
            box-shadow: 0 2px 8px rgba(74, 137, 220, 0.15);
        }
        .btn-back::before {
            content: '\f060';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-right: 8px;
        }
        /* 内容区域 */
        #content {
            padding: 30px;
            padding-bottom: 80px; /* 避免与底部重叠 */
        }
        /* 表格样式优化 */
        table#templateTable, table#templateTable th, table#templateTable td {
            text-align: center;
            border: none;
        }
        .reponsetable {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .reponsetable thead tr {
            background-color: #4a89dc;
            color: white;
        }
        .reponsetable thead th {
            padding: 15px !important;
            font-weight: 500;
            border: none !important;
        }
        .reponsetable tbody tr {
            background-color: white;
            transition: all 0.2s;
        }
        .reponsetable tbody tr:hover {
            background-color: #f0f5ff;
        }
        .reponsetable tbody td {
            padding: 15px !important;
            border-bottom: 1px solid #eee !important;
            color: #4a5568;
        }
        .btn-standard {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            background-color: #4a89dc;
        }
        .btn-standard:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-success {
            background-color: #2ecc71;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        /* 按钮内图标 */
        .btn-standard i {
            margin-right: 5px;
        }
        /* 底部 */
        #footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            text-align: center;
            padding: 15px 0;
            border-top: 1px solid #eee;
            font-size: 14px;
            color: #777;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        /* 卡片容器样式 */
        .card-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        /* 无数据提示 */
        #noDataMessage {
            text-align: center;
            padding: 50px 0;
            font-size: 18px;
            color: #7f8c8d;
        }
        #noDataMessage i {
            font-size: 50px;
            margin-bottom: 15px;
            color: #dfe6e9;
        }
        /* 顶部操作区 */
        .top-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        /* 链接样式 */
        .file-link {
            color: #4a89dc;
            text-decoration: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
        }
        .file-link:hover {
            color: #3a70c0;
            text-decoration: underline;
        }
        .file-link::before {
            content: '\f019';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-right: 8px;
        }
        .no-file {
            color: #999;
            font-style: italic;
        }
        /* 添加模板按钮 */
        .add-template-btn {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            background-color: #2ecc71;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .add-template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background-color: #27ae60;
        }
        .add-template-btn i {
            margin-right: 8px;
        }
        /* 响应式调整 */
        @media (max-width: 768px) {
            .top-actions {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .btn-standard {
                width: 100%;
            }
            
            #content {
                padding: 20px 15px;
                padding-bottom: 80px;
            }
            
            #header h1 {
                font-size: 18px;
            }
            
            .btn-back {
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
<div id="header">
    <h1>Teacher Profile</h1>
    <div id="user-menu">
        <span id="username"></span>
        <div id="dropdown">
            <a href="#" id="personalInfo">Personal Info</a>
            <a href="#" id="logout">Logout</a>
        </div>
    </div>
</div>

<div class="content-container">
    <div class="info-card">
        <form id="teacherForm">
            <div class="info-section">
                <h2><i class="fas fa-id-card"></i> Basic Information</h2>
                <div class="form-group">
                    <label class="required">Full Name</label>
                    <input type="text" class="form-view" name="teacherName" disabled required>
                    <div class="error-message">Please enter your full name</div>
                </div>
                
                <div class="form-group">
                    <label>Teacher ID</label>
                    <input type="text" class="form-view" name="teacherId" disabled readonly>
                </div>
            </div>

            <div class="info-section">
                <h2><i class="fas fa-cog"></i> Account Settings</h2>
                <div class="form-group">
                    <label class="required">Email</label>
                    <input type="email" class="form-view" name="email" disabled required>
                    <div class="error-message">Please enter a valid email address</div>
                </div>
                
                <div class="form-group">
                    <label class="required">Institution</label>
                    <input type="text" class="form-view" name="school" disabled required>
                    <div class="error-message">Please enter your institution</div>
                </div>
            </div>

            <div class="btn-container">
                <button type="button" class="btn-standard btn-edit" id="editBtn">
                    <i class="fas fa-edit"></i> Edit Profile
                </button>
                <button type="button" class="btn-standard btn-cancel" id="cancelBtn" style="display:none;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn-standard btn-save" id="saveBtn" style="display:none;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<div id="footer">
    <div>Version 1.0 | Contact Us: (852) 53137630</div>
    <div>©Copyright Ready Player One</div>
</div>
<script src="./js/config.js?v=2"></script>
<script src="./js/jquery.min.js?v=2"></script>
<script src="./layer/layer.js?v=2"></script>
<script src="./js/common.js?v=2"></script>
<script>
    let originalData = {};
    
    function toggleEditMode(enable) {
        const inputs = $('.form-view').not('[readonly]');
        const editBtn = $('#editBtn');
        const cancelBtn = $('#cancelBtn');
        const saveBtn = $('#saveBtn');

        inputs.prop('disabled', !enable);
        
        if (enable) {
            editBtn.hide();
            cancelBtn.show();
            saveBtn.show();
            inputs.first().focus();
        } else {
            editBtn.show();
            cancelBtn.hide();
            saveBtn.hide();
            // Reset form data
            Object.keys(originalData).forEach(key => {
                $(`input[name='${key}']`).val(originalData[key]);
            });
            // Clear error states
            $('.form-view').removeClass('error');
            $('.error-message').hide();
        }
    }

    const teacherName = sessionStorage.getItem("user_name");
        $("#username").text(teacherName);
    // 用户菜单相关事件
    $("#user-menu").click(function(e){
            $("#dropdown").toggle();
            e.stopPropagation();
    });
    $(document).click(function(){
        $("#dropdown").hide();
    });
    
    $("#personalInfo").click(function(e){
        e.preventDefault();
        window.location.href = "personal.html";
    });
    
    $("#logout").click(function(e){
        e.preventDefault(); 
        sendAjaxRequest("/user/logout", "DELETE", {}, 
            function() {
                window.location.href = "homepage.html";
            },
            function(error) {
                console.error("Logout error:", error);
                showErrorMessage("Logout failed. Please try again.");
            }
        );
    });
    
    function validateForm() {
        let isValid = true;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        // Validate required fields
        $('input[required]').each(function() {
            const input = $(this);
            const errorMsg = input.siblings('.error-message');
            
            if (!input.val().trim()) {
                input.addClass('error');
                errorMsg.show();
                isValid = false;
            } else if (input.attr('type') === 'email' && !emailRegex.test(input.val())) {
                input.addClass('error');
                errorMsg.text('Please enter a valid email address').show();
                isValid = false;
            } else {
                input.removeClass('error');
                errorMsg.hide();
            }
        });

        return isValid;
    }

    $('#editBtn').click(() => toggleEditMode(true));
    $('#cancelBtn').click(() => toggleEditMode(false));

    $('#teacherForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            layer.msg('Please fill in all required fields correctly', {icon: 2});
            return;
        }

        const updatedData = {
            user_id: sessionStorage.getItem("user_id"),
            name: $("input[name='teacherName']").val().trim(),
            email: $("input[name='email']").val().trim(),
            birth: $("input[name='birth']").val().trim(),
            gender: $("input[name='gender']").val().trim(),
            phone: $("input[name='phone']").val().trim(),
        };

        const loading = layer.load(1, {shade: [0.1,'#fff']});
        
        sendAjaxRequest("/api/teacher/update", "POST", updatedData,
            function(response) {
                layer.close(loading);
                if(response.code === 200) {
                    layer.msg('Profile updated successfully', {icon: 1});
                    originalData = {...updatedData};
                    toggleEditMode(false);
                    $("#username").text(updatedData.name);
                } else {
                    layer.msg('Update failed: ' + response.message, {icon: 2});
                }
            },
            function(error) {
                layer.close(loading);
                console.error("Update error:", error);
                layer.msg('Failed to update profile. Please try again later.', {icon: 2});
            }
        );
    });

    // Input validation on change
    $('input[required]').on('input', function() {
        const input = $(this);
        const errorMsg = input.siblings('.error-message');
        
        if (input.val().trim()) {
            input.removeClass('error');
            errorMsg.hide();
        }
    });

    // Fetch teacher info on load
    $(document).ready(function() {
        const loading = layer.load(1, {shade: [0.1,'#fff']});
        sendAjaxRequest("/api/teacher/info", "POST", {teacher_id: sessionStorage.getItem("user_id")},
            function(response) {
                layer.close(loading);
                if(response.code === 200) {
                    const data = response.data;
                    $("#username").text(data.name);
                    $("input[name='teacherName']").val(data.name);
                    $("input[name='teacherId']").val(data.teacher_id);
                    $("input[name='email']").val(data.email);
                    $("input[name='birth']").val(data.birth);
                    $("input[name='gender']").val(data.gender);
                    $("input[name='phone']").val(data.phone);
                    // Store original data for cancel operation
                    originalData = {
                        name: data.name,
                        email: data.email,
                        birth: data.birth,
                        gender: data.gender,
                        phone: data.phone
                    };
                } else {
                    layer.msg(response.message, {icon: 2});
                }
            },
            function(error) {
                layer.close(loading);
                console.error("API Error:", error);
                layer.msg(error, {icon: 2});
            }
        );
    });
</script>
</body>
</html>
